//>>built
require({cache:{"esri/dijit/Legend":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/json dojo/_base/Color dojo/has dojo/sniff dojo/DeferredList dojo/json dojo/dom dojo/dom-construct dojo/dom-style dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../kernel ../config ../request ../lang ../numberUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/jsonUtils ./_EventedWidget dojo/i18n!../nls/jsapi".split(" "),
function(y,z,s,m,p,x,q,h,k,A,D,t,e,u,B,P,U,v,Q,E,R,K,F,I,M,L,V,W,X,O,S,Y,N,Z,T){var J=z([Z,B],{declaredClass:"esri.dijit.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,defaultText:"Aa",gradientWidth:34,colorRampBorder:"1px solid",_specialChars:{lt:"\x3c",gt:"\x3e"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,constructor:function(a,b){s.mixin(this,T.widgets.legend);this._i18n=T.widgets.legend;a=a||
{};a.map?b?(this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?!1:!0,this._respectVisibility=!1===a.respectVisibility?!1:!0,this.arrangement=a.arrangement===J.ALIGN_RIGHT?J.ALIGN_RIGHT:J.ALIGN_LEFT,this.arrangement===J.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?!1:!0,this._surfaceItems=[]):console.error("esri.dijit.Legend: must specify a container for the legend"):console.error("esri.dijit.Legend: unable to find the 'map' property in parameters")},
postMixInProperties:function(){this.inherited(arguments);var a=["ar","he"],b,c;for(b=0;b<a.length;b+=1)c=a[b],y.locale&&-1!==y.locale.indexOf(c)&&(-1!==y.locale.indexOf("-")?-1!==y.locale.indexOf(c+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=this.alignRight?"left":"right",this._legendAlign=this.alignRight?"esriLegendLeft":"esriLegendRight"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esriLegendRight":"esriLegendLeft")},
startup:function(){this.inherited(arguments);this._initialize();9>h("ie")&&(this._repaintItems=s.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))},destroy:function(){this._deactivate();this._removeHoverHandlers();this.inherited(arguments)},refresh:function(a){if(this.domNode){a?(this.layerInfos=a,this.layers=[],m.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?
!0:!1,a.hideLayers?(a.layer._hideLayersInLegend=a.hideLayers,this._addSubLayersToHide(a)):a.layer._hideLayersInLegend=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this)):this.useAllMapLayers&&(this.layers=this.layerInfos=null);for(a=this.domNode.children.length-1;0<=a;a--)e.destroy(this.domNode.children[a]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",
_initialize:function(){this.layerInfos&&(this.layers=[],m.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(a.layer._hideLayersInLegend=a.hideLayers,this._addSubLayersToHide(a)):a.layer._hideLayersInLegend=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this));this.useAllMapLayers=
!1;if(!this.layers){this.useAllMapLayers=!0;this.layers=[];var a=[],b=[];m.forEach(this.map.layerIds,function(c){c=this.map.getLayer(c);var d;this._isSupportedLayerType(c)&&(c.arcgisProps&&c.arcgisProps.title&&(c._titleForLegend=c.arcgisProps.title),this.layers.push(c));"esri.layers.KMLLayer"==c.declaredClass&&(d=c.getLayers(),m.forEach(d,function(b){a.push(b.id)},this));"esri.layers.GeoRSSLayer"==c.declaredClass&&(d=c.getFeatureLayers(),m.forEach(d,function(a){b.push(a.id)},this))},this);m.forEach(this.map.graphicsLayerIds,
function(c){var d=this.map.getLayer(c);-1==m.indexOf(a,c)&&-1==m.indexOf(b,c)&&(this._isSupportedLayerType(d)&&d._params&&d._params.drawMode)&&(d.arcgisProps&&d.arcgisProps.title&&(d._titleForLegend=d.arcgisProps.title),this.layers.push(d))},this)}this._createLegend()},_activate:function(){this._deactivate();this.autoUpdate&&(this._respectCurrentMapScale&&(this._ozeConnect=p.connect(this.map,"onZoomEnd",this,"_refreshLayers")),this.useAllMapLayers&&(this._olaConnect=p.connect(this.map,"onLayerAdd",
this,"_updateAllMapLayers"),this._olrConnect=p.connect(this.map,"onLayerRemove",this,"_updateAllMapLayers"),this._olroConnect=p.connect(this.map,"onLayersReordered",this,"_updateAllMapLayers")),m.forEach(this.layers,function(a){a.ovcConnect=p.connect(a,"onVisibilityChange",this,"_refreshLayers");a.oscConnect=p.connect(a,"onScaleRangeChange",this,"_refreshLayers");"esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass&&a.supportsDynamicLayers&&(a.odcConnect=p.connect(a,"_onDynamicLayersChange",
s.hitch(this,"_updateDynamicLayers",a)));"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&(a.oirConnect=p.connect(a,"onRenderingChange",s.partial(this._updateImageServiceLayers,this,a)));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&(a.oivrConnect=p.connect(a,"onRendererChange",s.hitch(this,"_refreshLayers")))},this))},_deactivate:function(){this._ozeConnect&&p.disconnect(this._ozeConnect);this._olaConnect&&p.disconnect(this._olaConnect);this._olroConnect&&p.disconnect(this._olroConnect);
this._olrConnect&&p.disconnect(this._olrConnect);m.forEach(this.layers,function(a){a.ovcConnect&&p.disconnect(a.ovcConnect);a.oscConnect&&p.disconnect(a.oscConnect);a.odcConnect&&p.disconnect(a.odcConnect);a.oirConnect&&p.disconnect(a.oirConnect);a.oivrConnect&&p.disconnect(a.oivrConnect)},this)},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(a,b){delete b.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},
_updateAllMapLayers:function(){this.layers=[];m.forEach(this.map.layerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&this.layers.push(a)},this);m.forEach(this.map.graphicsLayerIds,function(a){a=this.map.getLayer(a);this._isSupportedLayerType(a)&&(a._params&&a._params.drawMode)&&this.layers.push(a)},this);this.refresh()},_createLegend:function(){var a=!1;u.set(this.domNode,"position","relative");e.create("div",{id:this.id+"_msg",className:"esriLegendMsg",innerHTML:this.NLS_creatingLegend+
"..."},this.domNode);var b=[];m.forEach(this.layers,function(c){if("esri.layers.KMLLayer"==c.declaredClass||"esri.layers.GeoRSSLayer"==c.declaredClass){var f;c.loaded?("esri.layers.KMLLayer"==c.declaredClass?f=c.getLayers():"esri.layers.GeoRSSLayer"==c.declaredClass&&(f=c.getFeatureLayers(),c._hideLayersInLegend&&(f=m.filter(f,function(a){return-1==m.indexOf(c._hideLayersInLegend,a.id)}))),m.forEach(f,function(a){"esri.layers.FeatureLayer"==a.declaredClass&&c._titleForLegend&&(a._titleForLegend=c._titleForLegend+
" - ","esriGeometryPoint"==a.geometryType?a._titleForLegend+=this.NLS_points:"esriGeometryPolyline"==a.geometryType?a._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==a.geometryType&&(a._titleForLegend+=this.NLS_polygons),b.push(a))},this)):p.connect(c,"onLoad",s.hitch(this,function(){this.refresh(this.layerInfos)}))}else if("esri.layers.WMSLayer"===c.declaredClass)if(c.loaded){if((!this._respectVisibility||this._respectVisibility&&c.visible)&&0<c.layerInfos.length&&m.some(c.layerInfos,function(a){return a.legendURL})){var g=
!1;m.forEach(c.layerInfos,function(b){b.legendURL&&-1<m.indexOf(c.visibleLayers,b.name)&&(g||(e.create("div",{innerHTML:"\x3cspan class\x3d'esriLegendServiceLabel'\x3e"+(c._titleForLegend||c.name||c.id)+"\x3c/span\x3e"},this.domNode),g=!0),e.create("div",{innerHTML:"\x3cimg src\x3d'"+b.legendURL+"'/\x3e"},this.domNode),a=!0)},this)}}else p.connect(c,"onLoad",s.hitch(this,function(){this.refresh(this.layerInfos)}));else b.push(c)},this);var c=[];m.forEach(b,function(a){if(a.loaded){if((!this._respectVisibility||
this._respectVisibility&&a.visible)&&(a.layerInfos||a.renderer||"esri.layers.ArcGISImageServiceLayer"==a.declaredClass)){var b=e.create("div",{id:this.id+"_"+a.id,style:{display:"none"},"class":"esriLegendService"});e.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},e.create("td",{align:this._align},e.create("tr",{},e.create("tbody",{},e.create("table",{width:"95%"},b)))));e.place(b,this.id,"first");a.legendResponse||a.renderer?this._createLegendForLayer(a):c.push(this._legendRequest(a))}}else var g=
p.connect(a,"onLoad",this,function(a){p.disconnect(g);g=null;this.refresh()})},this);0===c.length&&!a?(t.byId(this.id+"_msg").innerHTML=this.NLS_noLegend,this._activate()):(new A(c)).addCallback(s.hitch(this,function(b){a?t.byId(this.id+"_msg").innerHTML="":t.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this._activate()}))},_createLegendForLayer:function(a){if(a.legendResponse||a.renderer){var b=!1;if(a.legendResponse){var c=a.dynamicLayerInfos||a.layerInfos;c&&c.length?m.forEach(c,function(c,
f){if(!a._hideLayersInLegend||-1==m.indexOf(a._hideLayersInLegend,c.id)){var g=this._buildLegendItems(a,c,f);b=b||g}},this):"esri.layers.ArcGISImageServiceLayer"==a.declaredClass&&(b=this._buildLegendItems(a,{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},0))}else a.renderer&&(c=a.url?a.url.substring(a.url.lastIndexOf("/")+1,a.url.length):"fc_"+a.id,b=this._buildLegendItems(a,{id:c,name:null,subLayerIds:null,parentLayerId:-1},0));b&&(u.set(t.byId(this.id+"_"+a.id),"display","block"),
u.set(t.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(a){if(a.loaded)return 10.01<=a.version?this._legendRequestServer(a):this._legendRequestTools(a);p.connect(a,"onLoad",s.hitch(this,"_legendRequest"))},_legendRequestServer:function(a){var b=a.url,c=b.indexOf("?"),b=-1<c?b.substring(0,c)+"/legend"+b.substring(c):b+"/legend";(c=a._getToken())&&(b+="?token\x3d"+c);var d=s.hitch(this,"_processLegendResponse"),c={f:"json"};a._params.dynamicLayers&&(c.dynamicLayers=D.stringify(this._createDynamicLayers(a)),
"[{}]"===c.dynamicLayers&&(c.dynamicLayers="[]"));a._params.bandIds&&(c.bandIds=a._params.bandIds);a._params.renderingRule&&(c.renderingRule=a._params.renderingRule);return R({url:b,content:c,callbackParamName:"callback",load:function(b,c){d(a,b,c)},error:E.defaults.io.errorHandler})},_legendRequestTools:function(a){var b=a.url.toLowerCase().indexOf("/rest/"),b=a.url.substring(0,b)+a.url.substring(b+5,a.url.length),b=this._legendUrl+"?soapUrl\x3d"+window.escape(b);if(!h("ie")||8<h("ie"))b+="\x26returnbytes\x3dtrue";
var c=s.hitch(this,"_processLegendResponse");return R({url:b,content:{f:"json"},callbackParamName:"callback",load:function(b,f){c(a,b,f)},error:E.defaults.io.errorHandler})},_processLegendResponse:function(a,b){b&&b.layers?(a.legendResponse=b,t.byId(this.id+"_"+a.id)&&e.empty(t.byId(this.id+"_"+a.id)),e.create("span",{innerHTML:this._getServiceTitle(a),"class":"esriLegendServiceLabel"},e.create("td",{align:this._align},e.create("tr",{},e.create("tbody",{},e.create("table",{width:"95%"},t.byId(this.id+
"_"+a.id)))))),this._createLegendForLayer(a)):console.log("Legend could not get generated for "+a.url+": "+x.toJson(b))},_buildLegendItems:function(a,b,c){var d=!1,f=t.byId(this.id+"_"+a.id),g=b.parentLayerId;if(b.subLayerIds)a=e.create("div",{id:this.id+"_"+a.id+"_"+b.id+"_group",style:{display:"none"},"class":-1==g?0<c?"esriLegendGroupLayer":"":this._legendAlign},-1==g?f:t.byId(this.id+"_"+a.id+"_"+g+"_group")),e.create("td",{innerHTML:v.encode(b.name),align:this._align},e.create("tr",{},e.create("tbody",
{},e.create("table",{width:"95%","class":"esriLegendLayerLabel"},a))));else{if(a.visibleLayers&&-1==(","+a.visibleLayers+",").indexOf(","+b.id+","))return d;c=e.create("div",{id:this.id+"_"+a.id+"_"+b.id,style:{display:"none"},"class":-1<g?this._legendAlign:""},-1==g?f:t.byId(this.id+"_"+a.id+"_"+g+"_group"));e.create("td",{innerHTML:v.encode(b.name)||"",align:this._align},e.create("tr",{},e.create("tbody",{},e.create("table",{width:"95%","class":"esriLegendLayerLabel"},c))));a.legendResponse?d=d||
this._buildLegendItems_Tools(a,b,c):a.renderer&&(d=d||this._buildLegendItems_Renderer(a,b,c))}return d},_buildLegendItems_Tools:function(a,b,c){var d=b.parentLayerId,f=this.map.getScale(),g=!1,r=function(a,b){var c,d;for(c=0;c<a.length;c++)if(b.dynamicLayerInfos)for(d=0;d<b.dynamicLayerInfos[d].length;d++){if(b.dynamicLayerInfos[d].mapLayerId==a[c].layerId)return a[c]}else if(b.id==a[c].layerId)return a[c];return{}};if(!this._respectCurrentMapScale||this._respectCurrentMapScale&&this._isLayerInScale(a,
b,f)){var w=!0;if("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISMapServiceLayer"===a.declaredClass){var n=this._getEffectiveScale(a,b);if(n.minScale&&n.minScale<f||n.maxScale&&n.maxScale>f)w=!1}if(w){var f=r(a.legendResponse.layers,b),l=f.legendType,h=f.legend;if(h){c=e.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);var k=e.create("tbody",{},c);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(c,a,b);m.forEach(h,function(c){if(!(10.1<=
a.version&&!c.values&&1<h.length&&(a._hideDefaultSymbol||"\x3call other values\x3e"===c.label||!c.label&&!("esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.3<=a.version))))if(c.url&&0===c.url.indexOf("http")||c.imageData&&0<c.imageData.length)g=!0,this._buildRow_Tools(c,k,a,b.id,l)},this)}}}g&&(u.set(t.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<d&&(u.set(t.byId(this.id+"_"+a.id+"_"+d+"_group"),"display","block"),this._findParentGroup(a.id,a,d)));return g},_buildRow_Tools:function(a,
b,c,d,f){var g=e.create("tr",{},b),r;this.alignRight?(b=e.create("td",{align:this._isRightToLeft?"left":"right"},g),r=e.create("td",{align:this._isRightToLeft?"left":"right",width:35},g)):(r=e.create("td",{width:35},g),b=e.create("td",{},g));g=a.url;(!h("ie")||9<=h("ie")||9>h("ie")&&"esri.layers.ArcGISImageServiceLayer"===c.declaredClass)&&a.imageData&&0<a.imageData.length?g="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(g=c.url+"/"+d+"/images/"+a.url,(d=c._getToken())&&(g+="?token\x3d"+
d));d=e.create("img",{src:g,border:0,style:"opacity:"+c.opacity},r);a=e.create("td",{innerHTML:v.encode(a.label),align:this._align},e.create("tr",{},e.create("tbody",{},e.create("table",{width:"95%",dir:"ltr"},b))));f&&("Stretched"===f&&10.3<=c.version&&"esri.layers.ArcGISImageServiceLayer"===c.declaredClass)&&(a.style.verticalAlign="top",a.style.lineHeight="1",d.style.marginBottom="-1px",d.style.display="block",b.style.verticalAlign="top");9>h("ie")&&(d.style.filter="alpha(opacity\x3d"+100*c.opacity+
")")},_getVariable:function(a,b){var c;a&&(c=(c=a.getVisualVariablesForType(b))&&c[0]);return c},_getFieldAlias:function(a,b){var c=b.infoTemplate,c=c&&c.getFieldInfo&&c.getFieldInfo(a),d=b.getField(a),f=c||d,g="";f&&(g=c&&c.label||d&&d.alias||f.name||f.fieldName);return g},_getDefaultHoverLabel:function(a,b){var c;if(a){var d=this._getVariable(a,"colorInfo"),f=this._getVariable(a,"opacityInfo"),g=this._getVariable(a,"sizeInfo"),d=d||g||f,r,e,n,l,h;a instanceof S?r=a.field:a instanceof M&&!a.attributeField2&&
!a.attributeField3?(r=a.attributeField,d&&(n=d.field,l=d.normalizationField)):a instanceof L?d?(r=d.field,e=d.normalizationField):(r=a.attributeField,e=a.normalizationField,h="percent-of-total"===a.normalizationType):a instanceof I&&d&&(r=d.field,e=d.normalizationField);(h=l&&"showOpNormField"||n&&"showOpField"||e&&"showNormField"||(h?"showNormPct":null)||r&&"showField"||null)&&(c=K.substitute({field:r&&this._getFieldAlias(r,b),normField:e&&this._getFieldAlias(e,b),opField:n&&this._getFieldAlias(n,
b),opNormField:l&&this._getFieldAlias(l,b)},this._i18n[h]))}return c},_buildLegendItems_Renderer:function(a,b,c){var d=b.parentLayerId,f=this.map,g=f.getScale(),r=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(a,b,g)){var w,n,l="esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass?a.renderer.renderer:a.renderer,h,k,G,q,p;if(l instanceof V&&(l=(f="zoom"===l.rangeType?l.getRendererInfoByZoom(f.getZoom()):l.getRendererInfoByScale(g))&&f.renderer,!l))return!1;var f=this._getVariable(l,
"colorInfo"),g=this._getVariable(l,"opacityInfo"),H=this._getVariable(l,"sizeInfo"),C=this._getDefaultHoverLabel(l,a);f?(h=this._getMedianColor(l,f),f.field&&(G=s.isFunction(f.field)?null:a.getField(f.field))):g&&(p=s.isFunction(g.field)?null:a.getField(g.field));H&&H.field&&(q=s.isFunction(H.field)?null:a.getField(H.field));if(l instanceof S)r=!0,this._showHeatRamp(a,b,l,c,C);else if(l instanceof W)r=!0,this._showDotDensityLegend(a,b,l,c);else if(l instanceof X)r=!0,n=e.create("table",{cellpadding:0,
cellspacing:0,width:"95%","class":"esriLegendLayer"},c),w=e.create("tbody",{},n),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(n,a,b),l.latestObservationRenderer&&l.latestObservationRenderer instanceof I&&this._buildRow_Renderer(a,l.latestObservationRenderer.symbol,h,v.encode(l.latestObservationRenderer.label)||this.NLS_currentObservations,null,w),l.observationRenderer&&l.observationRenderer instanceof I&&this._buildRow_Renderer(a,l.observationRenderer.symbol,h,v.encode(l.observationRenderer.label)||
this.NLS_previousObservations,null,w);else if(l instanceof M){if(l.infos&&0<l.infos.length){r=!0;n=e.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c);w=e.create("tbody",{},n);(a._hoverLabel||a._hoverLabels||C)&&this._createHoverAction(n,a,b,C);var A=[];m.forEach(l.infos,function(b){var c=null;a._editable&&a.types&&(c=this._getTemplateFromTypes(a.types,b.value));var d=b.label;null==d&&(d=b.value);-1===m.indexOf(A,d)&&(A.push(d),this._buildRow_Renderer(a,b.symbol,
h,v.encode(d),c,w))},this)}}else if(l instanceof L){if(l.infos&&0<l.infos.length||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass)r=!0,n=e.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),w=e.create("tbody",{},n),(a._hoverLabel||a._hoverLabels||C)&&this._createHoverAction(n,a,b,C),n=l.infos.slice(0).reverse(),m.forEach(n,function(b){var c=b.label;null==c&&(c=(c=G||q||p)&&this._isSmartRenderer(l,c.name)?this._getFieldAlias(c.name,a):b.minValue+" - "+
b.maxValue);this._buildRow_Renderer(a,b.symbol,h,v.encode(c),null,w)},this),"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&(a.rendererStyle===O.STYLE_SCALAR||a.rendererStyle===O.STYLE_SINGLE_ARROW)&&this._buildRow_Renderer(a,l.defaultSymbol,null,"",null,w)}else l instanceof I&&(r=!0,n=e.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),w=e.create("tbody",{},n),(a._hoverLabel||a._hoverLabels||C)&&this._createHoverAction(n,a,b,C),k=null,a._editable&&
(a.templates&&0<a.templates.length)&&(k=a.templates[0]),n=(G||p)&&q?null:G||p||q,this._buildRow_Renderer(a,l.symbol,h,v.encode(n?this._getFieldAlias(n.name,a):l.label),k,w),k=l.symbol&&l.symbol.color,n&&(G=p=q=null));r&&(f&&f.field?(G&&this._isSmartRenderer(l,G.name)&&(G=null),this._showColorRamp(a,b,l,null,c,f,G,C)):g&&k&&this._showColorRamp(a,b,l,k,c,g,p,C),H&&H.field&&(q&&this._isSmartRenderer(l,q.name)&&(q=null),this._showSizeLegend(a,b,l,H,h,c,q,C)));!a._hideDefaultSymbol&&l.defaultSymbol&&(r=
!0,n=e.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},c),w=e.create("tbody",{},n),this._buildRow_Renderer(a,l.defaultSymbol,null,v.encode(l.defaultLabel)||"others",null,w))}r&&(u.set(t.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<d&&(u.set(t.byId(this.id+"_"+a.id+"_"+d+"_group"),"display","block"),this._findParentGroup(a.id,d)));return r},_isSmartRenderer:function(a,b){return a instanceof L&&a.infos&&1===a.infos.length&&a.attributeField===b},_showColorRamp:function(a,
b,c,d,f,g,r,w){var n;n=e.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},f);f=e.create("tbody",{},n);(a._hoverLabel||a._hoverLabels||w)&&this._createHoverAction(n,a,b,w);r&&this._addSubHeader(f,this._getFieldAlias(r.name,a));b=this._getRampStops(c,g,d);b.length&&this._drawColorRamp(f,b,!0,a,this._getRampBorderColor(c))},_getMedianColor:function(a,b){var c,d;b.colors?(c=b.minDataValue,d=b.maxDataValue):b.stops&&(c=b.stops[0].value,d=b.stops[b.stops.length-1].value);
return a.getColor(c+(d-c)/2,{colorInfo:b})},_getRampStops:function(a,b,c){var d,f,g,r,e=!1;b.colors||b.opacityValues?(f=b.maxDataValue-b.minDataValue,d=m.map([0,0.25,0.5,0.75,1],function(a){g=b.minDataValue+a*f;return Number(g.toFixed(6))}),this._checkPrecision(0,4,d)):b.stops&&(d=m.map(b.stops,function(a){return a.value}),(e=m.some(b.stops,function(a){return!!a.label}))&&(r=m.map(b.stops,function(a){return a.label})));var n=d[0],l,h,k;f=d[d.length-1]-n;return m.map(d,function(g,m){c?(l=new q(c.toRgba()),
h=a.getOpacity(g,{opacityInfo:b}),null!=h&&(l.a=h)):l=a.getColor(g,{colorInfo:b});k="";0===m?k=this._specialChars.lt+" ":m===d.length-1&&(k=this._specialChars.gt+" ");return{value:g,color:l,offset:1-(g-n)/f,label:e?r[m]:k+F.format(g)}},this).reverse()},_checkPrecision:function(a,b,c){var d=a+(b-a)/2,f=c[a],g=c[d],r=c[b],e=Math.floor(f),n=Math.floor(g),l=Math.floor(r);e===f&&(l===r&&n!==g&&e!==n&&l!==n)&&(c[d]=n);a+1!==d&&this._checkPrecision(a,d,c);d+1!==b&&this._checkPrecision(d,b,c)},_getRampBorderColor:function(a){var b;
if(a instanceof I)b=a.symbol;else if(a instanceof M||a instanceof L)b=a.infos[0].symbol;return(a=b&&-1===b.type.indexOf("linesymbol")?b.getStroke():null)&&a.color},_drawColorRamp:function(a,b,c,d,f){var g=e.create("tr",{},a),r,w,n,l,k,t=b.length-1,p;l=0;this.alignRight?(a=e.create("td",{align:this._isRightToLeft?"left":"right"},g),r=e.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},g)):(r=e.create("td",{width:this.gradientWidth,align:"center"},g),a=e.create("td",{},
g));var s=f&&0<f.a&&!(240<=f.r&&240<=f.g&&240<=f.b);w=e.create("div",{"class":s?"":"esriLegendBorderLessColorRamp",style:"position: relative; width:"+this.gradientWidth+"px;"},r);g=e.create("div",{"class":"esriLegendColorRamp"},w);r=u.get(g,"width");s&&(f=9>h("ie")?f.toHex():"rgba("+f.toRgba().join(",")+")",u.set(g,"border",this.colorRampBorder+" "+f));c?(f=this.gradientHeight*t,u.set(g,"height",f+"px")):f=u.get(g,"height");u.set(w,"height",f+"px");g=P.createSurface(g,r,f);9>h("ie")&&(l=g.getEventSource(),
u.set(l,"position","relative"),u.set(l.parentNode,"position","relative"),l=1);try{c&&m.forEach(b,function(a,b){a.offset=b/t}),k=g.createRect({x:-l,y:-l,width:r+l,height:f+l}),k.setFill({type:"linear",x1:0,y1:0,x2:0,y2:f,colors:b}).setStroke(null),g.createRect({width:r,height:f}).setFill(new q([255,255,255,1-d.opacity])).setStroke(null),this._surfaceItems.push(g)}catch(A){g.clear(),g.destroy()}m.forEach(b,function(a,c){if(a.label){p="top:"+100*a.offset+"%;";var d="";0===c&&(d+=" esriLegendColorRampTickFirst");
c===b.length-1&&(d+=" esriLegendColorRampTickLast");e.create("div",{"class":"esriLegendColorRampTick"+d,innerHTML:"\x26nbsp;",style:p},w)}});n=e.create("div",{"class":"esriLegendColorRampLabels",style:{height:f+this.gradientHeight+"px"}},a);c?m.forEach(b,function(a){e.create("div",{"class":"esriLegendColorRampLabel",innerHTML:v.encode(a.label)||"\x26nbsp;"},n)}):(e.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.high},n),e.create("div",{"class":"esriLegendColorRampLabel",innerHTML:this._i18n.low,
style:"top: "+(f+this.gradientHeight-2*this.gradientHeight)+"px;"},n))},_showHeatRamp:function(a,b,c,d,f){var g,r=c.field;g=e.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d);d=e.create("tbody",{},g);(a._hoverLabel||a._hoverLabels||f)&&this._createHoverAction(g,a,b,f);(r=r&&a.getField(r))&&this._addSubHeader(d,this._getFieldAlias(r.name,a));b=this._getHeatmapStops(c);b.length&&this._drawColorRamp(d,b,!1,a)},_getHeatmapStops:function(a){var b=a.colorStops;a=a.colors;
var c,d,f,g;if(b&&b[0])if(c=b.length-1,a=b[0]&&null!=b[0].ratio){if((a=b[c])&&1!==a.ratio)b=b.slice(0),b.push({ratio:1,color:a.color}),c++}else d=b[0].value,f=b[c].value-d,b=m.map(b,function(a){return{color:a.color,ratio:(a.value-d)/f}});else a&&a[0]&&(c=a.length-1,g=1/(a.length-1),b=m.map(a,function(a,b){return{color:a,ratio:b*g}}));b=m.map(b,function(a,b){var d="";0===b?d="Low":b===c&&(d="High");return{color:a.color,label:d,offset:1-a.ratio}});return b.reverse()},_showDotDensityLegend:function(a,
b,c,d){var f=c.legendOptions,g,r,h,n,l,k,t,q=this.dotDensitySwatchSize,p=Math.round(q/2);f&&(r=f.backgroundColor,h=f.outline,n=f.valueUnit,l=f.dotCoverage);l=(l||this.dotCoverage)/100;t=Math.round(q*q/Math.pow(c.dotSize,2)*l);d=e.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},d);k=e.create("tbody",{},d);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(d,a,b);this._addSubHeader(k,K.substitute({value:c.dotValue,unit:n||""},this.NLS_dotValue));m.forEach(c.fields,
function(b){b=s.mixin({},b);b.numPoints=t;g=new Y(c._generateImageSrc(q,q,[b],{x:0,y:0},{x:q,y:q},r),h||c.outline,q,q);b=a.getField(b.name)||b;this._buildRow_Renderer(a,g,null,v.encode(this._getFieldAlias(b.name,a)),null,k,{type:"path",path:"M "+-p+","+-p+" L "+p+","+-p+" L "+p+","+p+" L "+-p+","+p+" L "+-p+","+-p+" E"})},this)},_showSizeLegend:function(a,b,c,d,f,g,r,h){var n=d.legendOptions,n=n&&n.customValues,l,k,q=this._getSizeSymbol(c,f);"unknown"!==d.valueUnit||(!q||!n&&(null==d.minSize||null==
d.maxSize))||(f=e.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esriLegendLayer"},g),l=e.create("tbody",{},f),(a._hoverLabel||a._hoverLabels||h)&&this._createHoverAction(f,a,b,h),r&&this._addSubHeader(l,this._getFieldAlias(r.name,a)),k=n||this._getDataValues(c,q,d),k.reverse(),m.forEach(k,function(b,f){q=N.fromJson(q.toJson());this._applySize(q,c,d,b);b=F.format(b);var g="";0===f?g=this._specialChars.gt+" ":f===k.length-1&&(g=this._specialChars.lt+" ");g="\x3cspan class\x3d'esriLegendSizeRampLabel'\x3e"+
v.encode(g+b)+"\x3c/span\x3e";this._buildRow_Renderer(a,q,null,g,null,l)},this))},_getSizeSymbol:function(a,b){var c;if(a instanceof I)c=a.symbol;else if(a instanceof O)c=a.defaultSymbol;else if(a instanceof M||a instanceof L)c=a.infos[0].symbol;if(c=-1!==c.type.indexOf("fillsymbol")?null:c)c=N.fromJson(c.toJson()),b&&c.setColor(new q(b.toRgba()));return c},_getDataValues:function(a,b,c,d,f){f=null==f?20:f;d=this._interpolateSizeRange(c.minSize,c.maxSize,null==d?5:d);var g=m.map(d,function(a){return this._getDataValueFromSize(a,
c)},this),e,h,g=F.round(g);for(e=1;e<g.length-1;e++)if(h=this._roundDataValue(a,b,c,g[e],g[e-1],f))g[e]=h[0],d[e]=h[1];return g},_interpolateSizeRange:function(a,b,c){b=(b-a)/(c-1);var d,f=[];for(d=0;d<c;d++)f.push(a+b*d);return f},_getDataValueFromSize:function(a,b){var c=b.minSize,d=b.maxSize,f=b.minDataValue,g=b.maxDataValue;return c=a<=c?f:a>=d?g:(a-c)/(d-c)*(g-f)+f},_roundDataValue:function(a,b,c,d,f,g){var e=this._getSize(b,a,c,d);f=this._getSize(b,a,c,f);var h,n=F.getDigits(d),l=n.integer,
n=n.fractional,k,q,t,m,p,u,s,v,A,D,x;0<d&&1>d&&(h=Math.pow(10,n),d*=h,l=F.getDigits(d).integer);for(l-=1;0<=l&&!(k=Math.pow(10,l),n=Math.floor(d/k)*k,k*=Math.ceil(d/k),null!=h&&(n/=h,k/=h),q=(n+k)/2,q=F.round([n,q,k],{indexes:[1]})[1],t=this._getSize(b,a,c,n),m=this._getSize(b,a,c,k),p=this._getSize(b,a,c,q),u=F.getPctChange(e,t,f,null),s=F.getPctChange(e,m,f,null),v=F.getPctChange(e,p,f,null),A=u.prev<=g,D=s.prev<=g,A&&D&&(u.prev<=s.prev?(A=!0,D=!1):(D=!0,A=!1)),A?x=[n,t]:D?x=[k,m]:v.prev<=g&&(x=
[q,p]),x);l--);return x},_applySize:function(a,b,c,d){var f=a.type;b=this._getSize(a,b,c,d);switch(f){case "simplemarkersymbol":a.setSize(b);break;case "picturemarkersymbol":f=a.width;c=a.height;a.setHeight(b);a.setWidth(b*(f/c));break;case "simplelinesymbol":case "cartographiclinesymbol":a.setWidth(b);break;case "textsymbol":a.font&&a.font.setSize(b)}},_getSize:function(a,b,c,d){return b.getSize(d,{sizeInfo:c,shape:-1!==a.type.indexOf("markersymbol")?a.style:null})},_buildRow_Renderer:function(a,
b,c,d,f,g,k){var h=e.create("tr",{},g),n;this.alignRight?(g=e.create("td",{align:this._isRightToLeft?"left":"right"},h),n=e.create("td",{align:this._isRightToLeft?"left":"right",width:35},h)):(n=e.create("td",{width:35,align:"center"},h),g=e.create("td",{},h));var l=h=30;if("simplemarkersymbol"==b.type)h=Math.min(Math.max(h,b.size+12),125),l=Math.min(Math.max(l,b.size+12),125);else if("picturemarkersymbol"==b.type)h=Math.min(Math.max(h,b.width),125),l=Math.min(b.height||l,125);else if("textsymbol"==
b.type){var q,t;b.text||(q=b.text,t=!0,b.setText(this.defaultText));h=Math.min(Math.max(h,b.getWidth()+12),125);l=Math.min(Math.max(l,b.getHeight()+12),125);t&&b.setText(q)}q=e.create("div",{style:"width:"+h+"px;height:"+l+"px;"},n);K.isDefined(d)&&"number"===typeof d&&(d=""+d);e.create("td",{innerHTML:d||"",align:this._align},e.create("tr",{},e.create("tbody",{},e.create("table",{width:"95%"},g))));a=this._drawSymbol(q,b,c,h,l,f,a,k);this._surfaceItems.push(a)},_addSubHeader:function(a,b){var c=
e.create("tr",{},a),c=e.create("td",{align:this._align,colspan:2},c);e.create("td",{innerHTML:v.encode(b)||"",align:this._align},e.create("tr",{},e.create("tbody",{},e.create("table",{width:"95%"},c))))},_drawSymbol:function(a,b,c,d,f,g,e,k){b=N.fromJson(b.toJson());var n=e.opacity;c&&b.setColor(new q(c.toRgba()));if("simplelinesymbol"===b.type||"cartographiclinesymbol"===b.type||"textsymbol"===b.type){if(!b.color)return;c=b.color.toRgba();c[3]*=n;b.color.setColor(c)}else if("simplemarkersymbol"===
b.type||"simplefillsymbol"===b.type){if(!b.color)return;c=b.color.toRgba();c[3]*=n;b.color.setColor(c);b.outline&&b.outline.color&&(c=b.outline.color.toRgba(),c[3]*=n,b.outline.color.setColor(c))}else"picturemarkersymbol"===b.type&&(a.style.opacity=n,a.style.filter="alpha(opacity\x3d("+100*n+"))");a=P.createSurface(a,d,f);9>h("ie")&&(c=a.getEventSource(),u.set(c,"position","relative"),u.set(c.parentNode,"position","relative"));g=this._getDrawingToolShape(b,g)||N.getShapeDescriptors(b);var l,n=(c=
g.defaultShape)&&"text"===c.type;try{n&&!c.text&&(c.text=this.defaultText),l=a.createShape(k||c).setFill(g.fill).setStroke(g.stroke),n&&l.setFont(g.font)}catch(t){a.clear();a.destroy();return}var m=l.getBoundingBox();k=m.width;g=m.height;var n=-(m.x+k/2),p=-(m.y+g/2);c=a.getDimensions();n={dx:n+c.width/2,dy:p+c.height/2};if("simplemarkersymbol"===b.type&&"path"===b.style)d=e._getScaleMatrix(m,b.size),l.applyTransform(U.scaleAt(d.xx,d.yy,{x:c.width/2,y:c.height/2}));else if(k>d||g>f)e=k/d>g/f,d=((e?
d:f)-5)/(e?k:g),s.mixin(n,{xx:d,yy:d});l.applyTransform(n);return a},_getDrawingToolShape:function(a,b){var c;switch(b?b.drawingTool||null:null){case "esriFeatureEditToolArrow":c={type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"};break;case "esriFeatureEditToolTriangle":c={type:"path",path:"M -10,14 L 2,-10 L 14,14 L -10,14 E"};break;case "esriFeatureEditToolRectangle":c={type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 E"};break;case "esriFeatureEditToolCircle":c=
{type:"circle",cx:0,cy:0,r:10};break;case "esriFeatureEditToolEllipse":c={type:"ellipse",cx:0,cy:0,rx:10,ry:5};break;default:return null}return{defaultShape:c,fill:a.getFill(),stroke:a.getStroke()}},_repaintItems:function(){m.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());try{a.getFill&&a.setFill&&a.setFill(a.getFill())}catch(b){}a.children&&s.isArray(a.children)&&m.forEach(a.children,this._repaint,this)}},
_createHoverAction:function(a,b,c,d){if(d=b._hoverLabel||b._hoverLabels&&b._hoverLabels[c.id]||d)d=v.encode(d),b.mouseMoveHandler=b.mouseMoveHandler||{},b.mouseMoveHandler[c.id]=p.connect(a,"onmousemove",s.hitch(this,function(a,b){this.mouseX=b.clientX;this.mouseY=b.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,u.set(t.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(s.hitch(this,function(a,b,c){if(a==this.mouseX&&b==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=
!0,t.byId(this.id+"_hoverLabel")){var d=t.byId(this.id+"_hoverLabel");d.innerHTML="\x3cspan\x3e"+c+"\x3c/span\x3e";u.set(d,"top",b+"px");u.set(d,"left",a+15+"px");u.set(d,"display","")}else e.create("div",{innerHTML:"\x3cspan\x3e"+c+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esriLegendHoverLabel",style:{top:b+"px",left:a+15+"px"}},document.body)},b.clientX,b.clientY,a),500)},d)),b.mouseOutHandler=b.mouseOutHandler||{},b.mouseOutHandler[c.id]=p.connect(a,"onmouseout",s.hitch(this,function(a){this.mouseY=
this.mouseX=-1;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,u.set(t.byId(this.id+"_hoverLabel"),"display","none"))}))},_removeHoverHandlers:function(){var a;m.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)p.disconnect(b.mouseMoveHandler[a]);if(b.mouseOutHandler)for(a in b.mouseOutHandler)p.disconnect(b.mouseOutHandler[a])})},_createDynamicLayers:function(a){var b=[],c;m.forEach(a.dynamicLayerInfos||a.layerInfos,function(d){c={id:d.id};c.source=d.source&&d.source.toJson();
var f;a.layerDefinitions&&a.layerDefinitions[d.id]&&(f=a.layerDefinitions[d.id]);f&&(c.definitionExpression=f);var g;a.layerDrawingOptions&&a.layerDrawingOptions[d.id]&&(g=a.layerDrawingOptions[d.id]);g&&(c.drawingInfo=g.toJson());c.minScale=d.minScale||0;c.maxScale=d.maxScale||0;b.push(c)});return b},_getTemplateFromTypes:function(a,b){var c;for(c=0;c<a.length;c++)if(a[c].id==b&&a[c].templates&&0<a[c].templates.length)return a[c].templates[0];return null},_findParentGroup:function(a,b,c){var d,f=
b.dynamicLayerInfos||b.layerInfos;for(d=0;d<f.length;d++)if(c==f[d].id){-1<f[d].parentLayerId&&(u.set(t.byId(this.id+"_"+a+"_"+f[d].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,b,f[d].parentLayerId));break}},_addSubLayersToHide:function(a){function b(c,d){var f=a.layer.dynamicLayerInfos||a.layer.layerInfos,g,e;for(g=0;g<f.length;g++)if(f[g].id===c&&f[g].subLayerIds)for(e=0;e<f[g].subLayerIds.length;e++){var h=f[g].subLayerIds[e];-1===m.indexOf(d,h)&&(d.push(h),b(h,d))}}a.layer.layerInfos&&
m.forEach(a.layer._hideLayersInLegend,function(c){b(c,a.layer._hideLayersInLegend)})},_isLayerInScale:function(a,b,c){var d,f=!0;if(a.legendResponse&&a.legendResponse.layers)for(d=0;d<a.legendResponse.layers.length;d++){var g=a.legendResponse.layers[d];if(b.id==g.layerId){var e,h;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?(0==g.minScale&&a.tileInfo&&(e=a.tileInfo.lods[0].scale),0==g.maxScale&&a.tileInfo&&(h=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(e=Math.min(a.minScale,g.minScale)||
a.minScale||g.minScale,h=Math.max(a.maxScale,g.maxScale));if(0<e&&e<c||h>c)f=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<c||a.maxScale&&a.maxScale>c)f=!1;return f},_getServiceTitle:function(a){var b=a._titleForLegend;b||((b=a.url)?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+1,
b.length)):-1<a.url.indexOf("/FeatureServer")&&(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+a.vectorFieldPixelFilter.outputUnit]:this["NLS_"+a.vectorFieldPixelFilter.inputUnit],K.isDefined(a)&&(b+=" ("+a+")"));return v.encode(b)},_getEffectiveScale:function(a,
b){var c=b.minScale,d=b.maxScale;if(K.isDefined(b.parentLayerId)){var f=a.layerInfos,g=b.parentLayerId,e;for(e=f.length-1;0<=e;e--)if(f[e].id==g)if(0==c&&0<f[e].minScale?c=f[e].minScale:0<c&&0==f[e].minScale||0<c&&0<f[e].minScale&&(c=Math.min(c,f[e].minScale)),d=Math.max(d||0,f[e].maxScale||0),-1<f[e].parentLayerId)g=f[e].parentLayerId;else break}return{minScale:c,maxScale:d}},_isSupportedLayerType:function(a){return a&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===
a.declaredClass&&10.2<=a.version||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass)?!0:!1}});s.mixin(J,{ALIGN_LEFT:0,ALIGN_RIGHT:1});return J})},"esri/numberUtils":function(){define(["dojo/has",
"dojo/number","dojo/i18n!dojo/cldr/nls/number","./kernel"],function(y,z,s,m){var p=function(q,h){return q-h},x={_reNumber:/^-?(\d+)(\.(\d+))?$/i,getDigits:function(q){var h=String(q),k=h.match(x._reNumber);q={integer:0,fractional:0};k&&k[1]?(q.integer=k[1].split("").length,q.fractional=k[3]?k[3].split("").length:0):-1<h.toLowerCase().indexOf("e")&&(k=h.split("e"),h=k[0],k=k[1],h&&k&&(h=Number(h),k=Number(k),(q=0<k)||(k=Math.abs(k)),h=x.getDigits(h),q?(h.integer+=k,h.fractional=k>h.fractional?0:h.fractional-
k):(h.fractional+=k,h.integer=k>h.integer?1:h.integer-k),q=h));return q},getFixedNumbers:function(q,h){var k,m;k=Number(q.toFixed(h));m=k<q?k+1/Math.pow(10,h):k-1/Math.pow(10,h);return[k,m]},getPctChange:function(q,h,k,m){var p={prev:null,next:null},t;null!=k&&(t=q-k,k=h-k-t,p.prev=Math.floor(Math.abs(100*k/t)));null!=m&&(t=m-q,k=m-h-t,p.next=Math.floor(Math.abs(100*k/t)));return p},round:function(q,h){var k=q.slice(0),m,s,t,e,u,B,y,z,v,Q=!h||null==h.tolerance?2:h.tolerance,E=h&&h.indexes;if(E)E.sort(p);
else{E=[];for(B=0;B<k.length;B++)E.push(B)}for(B=0;B<E.length;B++)if(v=E[B],m=k[v],s=0===v?null:k[v-1],t=v===k.length-1?null:k[v+1],e=x.getDigits(m),e=e.fractional){y=0;for(z=!1;y<=e&&!z;)u=x.getFixedNumbers(m,y),u=u[0],z=x.hasMinimalChange(m,u,s,t,Q),y++;z&&(k[v]=u)}return k},hasMinimalChange:function(m,h,k,p,s){m=x.getPctChange(m,h,k,p);h=null==m.prev||m.prev<=s;k=null==m.next||m.next<=s;return h&&k||m.prev+m.next<=2*s},_reAllZeros:RegExp("\\"+s.decimal+"0+$","g"),_reSomeZeros:RegExp("(\\d)0*$",
"g"),format:function(m,h){h=h||{places:20,round:-1};var k=z.format(m,h);k&&(k=k.replace(x._reSomeZeros,"$1").replace(x._reAllZeros,""));return k}};return x})},"widgets/Legend/_build-generate_module":function(){define(["dojo/text!./Widget.html","dojo/text!./css/style.css","dojo/i18n!./nls/strings","dojo/text!./config.json"],function(){})},"url:widgets/Legend/Widget.html":'\x3cdiv\x3e\r\n  \x3cdiv data-dojo-attach-point\x3d"legendDiv"\x3e\x3c/div\x3e\r\n  \x3cdiv style\x3d"display:none" data-dojo-attach-point\x3d"removedDiv"\x3e\x3c/div\x3e\r\n\x3c/div\x3e\r\n\r\n\r\n',
"url:widgets/Legend/css/style.css":".esriLegendServiceLabel {font-size: 14px;}.esriLegendLayer{font-size: 12px;}","url:widgets/Legend/config.json":'{\r\n  "legend":{\r\n    "arrangement": 0,\r\n    "autoUpdate": true,\r\n    "respectCurrentMapScale": true\r\n  }\r\n}',"*now":function(y){y(['dojo/i18n!*preload*widgets/Legend/nls/Widget*["ar","cs","da","de","en","el","es","et","fi","fr","he","it","ja","ko","lt","lv","nb","nl","pl","pt-br","pt-pt","ro","ru","sv","th","tr","zh-cn","vi","ROOT"]'])}}});
define("dojo/_base/declare dojo/_base/array dojo/_base/lang dojo/dom dojo/on dojo/aspect dijit/_WidgetsInTemplateMixin jimu/BaseWidget jimu/LayerInfos/LayerInfos jimu/dijit/Message esri/dijit/Legend".split(" "),function(y,z,s,m,p,x,q,h,k,A,D){return y([h,q],{name:"Legend",baseClass:"jimu-widget-legend",layerInfos:[],legend:null,startup:function(){this.inherited(arguments);k.getInstance(this.map,this.map.itemInfo).then(s.hitch(this,function(h){this.config.legend.map=this.map;this.legend=new D(this.config.legend,
this.legendDiv);this.legend.startup();this.removeLegendOfBasemap();this.legend&&this.legend._createLegend&&x.after(this.legend,"_createLegend",s.hitch(this,"removeLegendOfBasemap"));this.own(p(h,"layerInfosIsShowInMapChanged",s.hitch(this,"onLayersVisibilityChange")))}),s.hitch(this,function(h){console.error(h);new A({message:h.message||h})}))},onLayersVisibilityChange:function(){this.legend.refresh()},_getInvalidLegendLayer:function(){var h=[],e=this.map.getBasemap();this.map.itemInfo&&this.map.itemInfo.itemData?
(z.forEach(this.map.itemInfo.itemData.baseMap.baseMapLayers,function(e){h.push(e.id)}),z.forEach(this.map.itemInfo.itemData.operationalLayers,function(e){!1===e.showLegend&&h.push(e.id)}),z.forEach(this.map.layerIds,s.hitch(this,function(e){this.map.getLayer(e)._basemapGalleryLayerType&&h.push(e)}))):z.forEach(this.map.layerIds,s.hitch(this,function(e){this.map.getLayer(e).isOperationalLayer||h.push(e)}));e&&h.push(e);return h},removeLegendOfBasemap:function(){z.forEach(this._getInvalidLegendLayer(),
function(h){(h=m.byId(this.legend.id+"_"+h))&&1===h.nodeType&&this.removedDiv.appendChild(h)},this)}})});