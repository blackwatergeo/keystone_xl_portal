//>>built
define(["dojo/_base/lang","dojo/_base/array","jimu/LayerInfos/LayerInfos","dojo/Deferred","dojo/promise/all"],function(e,f,k,g,h){function m(a){var b=[],d=[];f.forEach(a,function(c){0>b.indexOf(c.name)?b.push(c.name):d.push(c)});f.forEach(d,function(c){c.name=c.name+"-"+c.id})}var l={readLayerInfosObj:function(a){return k.getInstance(a,a.itemInfo)},readLayerInfosFromMap:function(a){var b=new g;k.getInstance(a,a.itemInfo).then(e.hitch(this,function(a){var c=[];a.traversal(e.hitch(this,function(a){c.push(a)}));
a=a.getTableInfoArray();c=c.concat(a);b.resolve(c)}),e.hitch(this,function(a){console.error(a);b.reject(a)}));return b.promise},readLayerObjectsFromMap:function(a){var b=new g,d=[];this.readLayerInfosFromMap(a).then(e.hitch(this,function(a){f.forEach(a,e.hitch(this,function(a){d.push(a.getLayerObject())}));h(d).then(e.hitch(this,function(a){b.resolve(a)}),e.hitch(this,function(a){b.reject(a);console.error(a)}))}),e.hitch(this,function(a){b.reject(a)}));return b.promise},readSupportTableInfoFromLayerInfos:function(a){var b=
new g,d=[];f.forEach(a,e.hitch(this,function(a){d.push(a.getSupportTableInfo())}));h(d).then(e.hitch(this,function(c){c=e.clone(c);f.forEach(c,function(b,c){b.id=a[c].id});b.resolve(c)}),function(a){b.reject(a)});return b.promise},readConfigLayerInfosFromMap:function(a){var b=new g,d=[];this.readLayerInfosFromMap(a).then(e.hitch(this,function(a){var g=[];f.forEach(a,function(a){d.push(a.getSupportTableInfo())});h(d).then(e.hitch(this,function(d){f.forEach(d,e.hitch(this,function(b,d){b.isSupportedLayer&&
(a[d].name=a[d].title,g.push(a[d]))}));m(g);b.resolve(g)}),e.hitch(this,function(a){b.reject(a)}))}),e.hitch(this,function(a){b.reject(a)}));return b.promise},getConfigInfosFromLayerInfos:function(a){return f.map(a,function(a){return l.getConfigInfoFromLayerInfo(a)})},getConfigInfoFromLayerInfo:function(a){var b={};b.name=a.name||a.title;b.id=a.id;b.show=a.isShowInMap();b.layer={url:a.getUrl()||a.layerObject&&a.layerObject.url};if((a=a.getPopupInfo())&&!a.description)b.layer.fields=f.map(a.fieldInfos,
function(a){return{name:a.fieldName,alias:a.label.toLowerCase(),show:a.visible}});return b}};return l});